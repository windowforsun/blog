--- 
layout: single
classes: wide
title: "[Kafka] Kafka CDC Outbox"
header:
  overlay_image: /img/kafka-bg.jpg
excerpt: 'Kafka CDC Outbox 를 활용한 데이터 변경 캡쳐 및 전파 방식에 대해 알아보자'
author: "window_for_sun"
header-style: text
categories :
  - Kafka
tags:
    - Practice
    - Kafka
    - Kafka Connect
    - Debezium
    - CDC
    - Outbox
    - MSA
    - Event Driven
    - Kafka Topic
    - Kafka Producer
    - Kafka Consumer
    - Kafka Streams
toc: true
use_math: true
---  

## Kafka CDC Outbox
`Kafka CDC Outbox`(데이터 변경 캡쳐)는 `MSA` 에서 데이터의 일관성 있는 전파와 통합을 위한 강력한 패턴이다. 
`MSA` 를 구성하는 각 서비스에서 데이터를 변경 할 떄 발생하는 이벤트를 캡쳐하고 이를 `Kafka` 를 통해 다른 서비스로 전달하는 방식으로 동작한다. 
이를 활용하면 데이터 일관성을 유지하면서 서비스간 느슨한 결합을 구현 할 수 있다.  

`MSA` 는 각 서비스가 다루는 데이터를 전파하고 데이터 변경 사항을 전달하는 방식으로 구성된다. 
구매 주문을 관리하는 `MSA` 가 있다고 가정하면, 새로운 주문이 접수되면 그 주문에 대한 정보가 배승 서비스와 고객 서비스로 전달되는 것이 필요하다.  

주문 서비스가 새로운 주문에 대해 다른 서비스에 해당 사항을 전파하는 방식에는 다양한 방법이 있다. 
가장 대표적인 방법이 `REST API` 와 같은 것을 이용해 동기적으로 호출하는 것이다. 
하지만 이런 방식에는 의도치 않은 강한 결합을 생성할 수 있다. 
주문 서비스가 `REST API` 를 통해 각 서비스에 전파하기 위해서는 전파해야 하는 대상 서비스의 위치(도메인)과 
해당 서비스가 전파를 받을 수 있는 상태인지 등을 고려해야하 한다. 
만약 일시적으로 가용불가 상태라면 이후 재전송처리는 어떻게 할지도 고민이 필요하다.  

이러한 동기적인 전달방식의 문제점은 두 엔드포인트가 모두 존재하고 가용 가능상태여야 이벤트 전달이 가능하다는 것이다. 
또한 두 엔드포인트간 이벤트를 전달 할때 한쪽이 빠르게 전달하면, 받는 쪽은 그 속도에 맞춰 이벤트를 받아 처리해야 한다. 
즉 이벤트 전달에 있어서 버퍼링 혹은 `backpressure` 의 역할이 없으므로 이에 대한 고민도 필요하다. 
또한 새로 실행된 인스턴스의 경우 이전 이벤트를 수신할 수 없다는 점도 있다.  

이렇게 동기적인 방식에 따른 문제점들은 비동기 이벤트 전달 방식을 사용하면 해결 가능하다. 
즉 이벤트를 각 목적에 맞는 `Kafka Topic` 과 같은 것을 사용해서 이벤트를 전파하는 것이다. 
그리고 이벤트가 필요한 서비스는 해당 토픽을 구독해 이벤트 스트림상에 전달되는 변경사항을 받아 목적에 맞는 처리를 수행 할 수 있다.  

이러한 비동기 방식이 장점 중 하나는 이벤트를 전달하는 서비스와는 별도로 해당 이벤트가 필요로하는 서비스를 필요에 따라 추가할 수 있다는 점이다. 
이는 초기 구현에는 고려되지 못했던 다양한 케이스에 대해 유연하게 대응 가능하다는 장점이 있다. 
주문에 대한 이벤트를 기존에는 배송 서비스에서만 변경사항을 받아 처리했는데 
이후 더 추가적인 로깅 혹은 분석을 위해 `Elasticsearch` 에 저장하는 등으로 확장이 가능하다. 
또한 `Kafka Topic` 은 일정기간 메시지를 보존 할 수 있는데 이를 통해 이전 이벤트 히스토리를 파악한다던가, 
새롭게 투입되는 서비스에서도 이벤트 히스토리를 재생해 기반 데이터를 구축 할 수 있다.  

해당 포스팅에서 사용하는 코드 예시 및 데모 프로젝트의 전체 내용은 [여기](https://github.com/windowforsun/cdc-outbox-exam)
에서 확인 할 수 있다.  
